"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var PropInput=function(){function t(e){return _classCallCheck(this,t),this._wrappedInput(e)}return _createClass(t,[{key:"_wrappedInput",value:function(e){var t=this._input(e);return this._wrap(t)}},{key:"_input",value:function(e){var n=this,r=Object.assign(document.createElement("input"),{name:e.name,value:e.value});return r.dataset.defaultValue=e.value,r.dataset.prop=JSON.stringify(e),["input","focus","blur","keydown"].forEach(function(t){r.addEventListener(t,function(e){return n["on_".concat(t)](e)})}),r.dispatchEvent(new Event("input")),r}},{key:"_wrap",value:function(e){var t=document.createElement("field");t.classList.add("field");var n=document.createElement("label");return n.innerText=this._normalizePropName(e.name),n.title=e.name,[n,e].forEach(function(e){return t.append(e)}),t}},{key:"_normalizePropName",value:function(e){var t=e.match(/(?:--[^-]*)/g);return e.replace(t,"").split("-").join(" ")}},{key:"on_input",value:function(e){var t=e.target;this._updateBorderColor(t),this._updateTheme(t)}},{key:"on_focus",value:function(e){var t=e.target;t.dataset.currentValue=t.value,t.setSelectionRange(0,t.value.length)}},{key:"on_blur",value:function(e){var t=e.target;t.removeAttribute("list"),this._updateDatalist(t),t.removeAttribute("data-current-value")}},{key:"on_keydown",value:function(e){var t=e.target;t.setAttribute("list","theme-editor-datalist");var n={38:"inc",187:"inc",40:"dec",189:"dec"};27===e.keyCode&&(t.value=t.dataset.currentValue),n[e.keyCode]&&this._increaseDecreaseNumbers(t,n[e.keyCode]),this._updateTheme(t)}},{key:"_updateTheme",value:function(e){var t=this;clearTimeout(e._typing);var n=e.value!==e.dataset.defaultValue;e.classList[n?"add":"remove"]("not-default"),e._typing=setTimeout(function(){e.classList.contains("not-default")?t.setCssProp(e.name,e.value):t.unsetCssProp(e.name)},100)}},{key:"_isCssColor",value:function(e){var t=(new Option).style;return t.color=e,!!t.color}},{key:"_updateBorderColor",value:function(e){var t=e.value;t&&(t.startsWith("var(--")||this._isCssColor(t))?e.style.borderColor=t:e.style.borderColor="#aaaaaa"}},{key:"_updateDatalist",value:function(e){var t=document.querySelector("#theme-editor form datalist");t.optionsIndex.includes(e.value)||t.addOption(e.value)}},{key:"_increaseDecreaseNumbers",value:function(e,n){var t=e.value.split(/(\d+)/).filter(function(e){return!!e});t=t.map(function(e){var t=Number(e);return t||0===Number(e)?"inc"==n?t+=1:1<=t?--t:t:e}),e.value=t.join(""),e.value.startsWith("#")&&7<e.value.length&&(e.value=e.value.substring(0,7))}},{key:"setCssProp",value:function(e,t){document.documentElement.style.setProperty(e,t)}},{key:"unsetCssProp",value:function(e){document.documentElement.style.removeProperty(e)}}]),t}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var ThemeEditor=function(){function t(e){_classCallCheck(this,t),this.FORM=document.querySelector(e.form),this.CSS_CUSTOM_PROPS=e.propset,this.render()}return _createClass(t,[{key:"render",value:function(){var e=this._customPropsToInputs(this.CSS_CUSTOM_PROPS);this._renderPropsInputs(this.FORM,e),this.FORM.append(this._createPropsDataList()),this._addThemePreviewAction(".preview-theme"),this._addDownloadThemeAction(".download-theme"),this._addCssCustomPropsIndex("#proplist")}},{key:"_createPropsDataList",value:function(){var n=Object.assign(document.createElement("datalist"),{id:"theme-editor-datalist",optionsIndex:[]});return n.addOption=function(e){if(e&&e.startsWith("--")&&(e="var(".concat(e,")")),e&&!n.optionsIndex.includes(e)){n.optionsIndex.push(e);var t=Object.assign(document.createElement("option"),{innerText:e});n.append(t)}},this.FORM.querySelectorAll("input").forEach(function(e){[e.name,e.value,e.dataset.defaultValue].forEach(function(e){n.addOption(e)})}),n}},{key:"_createPropInput",value:function(e){return new PropInput(e)}},{key:"_createHolder",value:function(){return document.createElement("div")}},{key:"_customPropsToInputs",value:function(e){var t=this;return e.map(function(e){return e.map(function(e){return t._createPropInput(e)})})}},{key:"_renderPropsInputs",value:function(e,t){var n=this;t.forEach(function(e){var t=n._createHolder();e.forEach(function(e){t.append(e)}),n.FORM.append(t)})}},{key:"_addThemePreviewAction",value:function(e){var t=document.getElementById("custom-theme-code-mirror"),n=this._initializeCodeMirror(t);document.querySelectorAll(e).forEach(function(e){e.addEventListener("click",function(e){var t=ThemeUtils.getCustomTheme();n.setValue(t),n.refresh()})})}},{key:"_addDownloadThemeAction",value:function(e){var r=this;document.querySelectorAll(e).forEach(function(e){e.addEventListener("click",function(e){var t=ThemeUtils.getCustomTheme(),n=r._slugify(document.querySelector('[name="plume-custom-theme-name"]').value||"untitled");r._saveFile("plume-theme-".concat(n,".css"),t)})})}},{key:"_initializeCodeMirror",value:function(e){var t=CodeMirror.fromTextArea(e,{mode:"css",readOnly:!0,lineNumbers:!0});return t.setSize("100%","100%"),t}},{key:"_slugify",value:function(e){return e.toString().toLowerCase().normalize("NFD").trim().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-")}},{key:"_saveFile",value:function(e,t,n){var r=2<arguments.length&&void 0!==n?n:"data:attachment/text";if(null!==t&&navigator.msSaveBlob)return navigator.msSaveBlob(new Blob([t],{type:r}),e);var a=document.createElement("a");a.style.diplay="none";var o=window.URL.createObjectURL(new Blob([t],{type:r}));a.setAttribute("href",o),a.setAttribute("download",e),document.body.append(a),a.click(),window.URL.revokeObjectURL(o),a.remove()}},{key:"_addCssCustomPropsIndex",value:function(r){r=document.querySelector(r),this.CSS_CUSTOM_PROPS.forEach(function(e){var n=document.createElement("div");e.forEach(function(e){var t=Object.assign(document.createElement("div"),{innerText:e.name});n.append(t),r.append(n)})})}}]),t}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var ThemeUtils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"getStyleSheetArray",value:function(e,t){var n=document.getElementById(e),r=n?Array.from(n.sheet.rules||n.sheet.cssRules):void 0;return r&&t&&(r=this.filterBySelector(t,r)),r}},{key:"filterBySelector",value:function(t,e){return e.length?e.filter(function(e){return e.selectorText===t}):void 0}},{key:"getCustomPropsFromStr",value:function(e){return e.match(/(?:--[^;]*)/g).map(function(e){return{name:(t=e.split(":"))[0],value:t[1].replace(";","")};var t})}},{key:"getCustomPropsFromStyleSheet",value:function(e,t){var n=this,r=1<arguments.length&&void 0!==t?t:":root";return this.getStyleSheetArray(e,r).map(function(e){return n.getCustomPropsFromStr(e.cssText)})}},{key:"getCustomTheme",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e,n=document.querySelector('[name="plume-custom-theme-scope"]').value||":root",r=document.documentElement.style.cssText;return r.indexOf("--pm-")<0?r="/* You didn't modified any default property. */":t&&(r=cssbeautify("".concat(n," { ").concat(r," }"),{indent:"  ",autosemicolon:!0})),r}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var URLHandler=function(){function t(e){_classCallCheck(this,t),this.FORM=document.querySelector(e.form),this._init()}return _createClass(t,[{key:"_init",value:function(){this._loadState(),this._addInputListeners()}},{key:"_clearState",value:function(e){e&&console.warn("PLUME CSS WARN: A problem occurred while loading Plume Theme from URL data. Default theme loaded.\nError Ref: ".concat(e)),window.history.pushState({},document.title,window.location.href.split("?")[0])}},{key:"_addInputListeners",value:function(){var n=this;this.FORM.querySelectorAll("input").forEach(function(t){["input","keyup","blur"].forEach(function(e){t.addEventListener(e,function(){n._saveState()})})})}},{key:"_loadState",value:function(){try{var e=window.location.search.slice(1);if(e&&e.length){var t=this._decompress_str(e);t?this._loadFormData(t):this._clearState("Malformed theme string")}}catch(e){this._clearState(e)}}},{key:"_saveState",value:function(){if(document.querySelector(".not-default")){var e=this._serialize(this.FORM),t=this._compress_str(e);window.history.pushState({},document.title,"?".concat(t))}else this._clearState()}},{key:"_loadFormData",value:function(e){var n=this;decodeURIComponent(e).split("&").map(function(e){return{name:e.split("=")[0],value:e.split("=")[1]}}).forEach(function(e){if(e.name&&e.value){var t=n.FORM.querySelector('input[name="'.concat(e.name,'"]'));t.value=e.value,t.dispatchEvent(new Event("input"))}})}},{key:"_serialize",value:function(){var t=[];return this.FORM.querySelectorAll("input.static, input.not-default").forEach(function(e){t.push(encodeURIComponent(e.name)+"="+encodeURIComponent(e.value))}),t.join("&")}},{key:"_compress_str",value:function(e){return LZString.compressToEncodedURIComponent(e)}},{key:"_decompress_str",value:function(e){return LZString.decompressFromEncodedURIComponent(e)}}]),t}();!function(){var e=ThemeUtils.getCustomPropsFromStyleSheet("plume",":root");new ThemeEditor({propset:e,form:"#theme-editor form"}),new URLHandler({form:"#theme-editor form"})}();